<!DOCTYPE html>

<head>
    <title>palabritas</title>
    <style>
        /* TODO the standard stuff you put at the top of a CSS */
        /* probably use SASS so we can get a preprocessor */
        body {
            font-size: 2em;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .scramble-container {
            margin: 0.5em;
        }

        .entry-container {}

        .answer-container {
            display: flex;
        }

        .score {
            margin: 0.25em;
        }

        .word {
            padding: 0.5em;
        }
    </style>
    <script>
        const isNullOrUndefined = (value) => value == null;

        if (!Array.prototype.last) {
            Array.prototype.last = function () {
                return this[this.length - 1];
            };
        };

        if (!Array.prototype.first) {
            Array.prototype.first = function () {
                return this[0];
            };
        };

        class LetterBox extends HTMLElement {
            static placeholderKey = 'placeholder'
            static valueKey = 'value'

            constructor() {
                super();

                this.attachShadow(({ mode: 'open' }));
                this.shadowRoot.append(LetterBox.template.content.cloneNode(true));

                this.innerSpan = this.shadowRoot.querySelector('.letter');
            }

            attributeChangedCallback(name, oldValue, newValue) {
                if (name === LetterBox.valueKey && newValue) {
                    this.innerSpan.textContent = newValue;
                } else if (name === LetterBox.placeholderKey && !this.value) {
                    this.innerSpan.textContent = newValue;
                } else {
                    this.innerSpan.textContent = this.placeholder;
                }
            }

            get placeholder() { return this.getAttribute(LetterBox.placeholderKey) };
            get value() { return this.getAttribute(LetterBox.valueKey) };

            set placeholder(value) { this.setAttribute(LetterBox.placeholderKey, value) };
            set value(value) { this.setAttribute(LetterBox.valueKey, value) };
        }

        LetterBox.observedAttributes = [LetterBox.placeholderKey, LetterBox.valueKey];
        LetterBox.template = document.createElement('template');

        LetterBox.template.innerHTML = `
        <style>
            :host {
                user-select: none;
            }

            .letter-container {
                background-color: #333030e8;
                border: black solid 1px;
                cursor: default;
                display: inline-block;
                height: 1.3em;                
                width: 1.3em;
            }

            .letter {
                color: white;
                display: inline-block;
                padding-top: 2px;
                text-align: center;
                text-transform: uppercase;
                width: 100%;
            }
        </style>
        <span class="letter-container">
            <span class="letter"></span>
        </span>
        `;

        customElements.define('p-letter-box', LetterBox);
    </script>
</head>

<body>
    <div class="main-container">
        <!-- <h1 class="score">Score 0</h1> -->
        <div class="scramble-container">
            <p-letter-box id="letter-1"></p-letter-box>
            <p-letter-box id="letter-2"></p-letter-box>
            <p-letter-box id="letter-3"></p-letter-box>
            <p-letter-box id="letter-4"></p-letter-box>
            <p-letter-box id="letter-5"></p-letter-box>
            <p-letter-box id="letter-6"></p-letter-box>
        </div>

        <div class="entry-container">
            <p-letter-box id="entry-1" placeholder="_"></p-letter-box>
            <p-letter-box id="entry-2" placeholder="_"></p-letter-box>
            <p-letter-box id="entry-3" placeholder="_"></p-letter-box>
            <p-letter-box id="entry-4" placeholder="_"></p-letter-box>
            <p-letter-box id="entry-5" placeholder="_"></p-letter-box>
            <p-letter-box id="entry-6" placeholder="_"></p-letter-box>
        </div>

        <!--
        <div class="answer-container">
            <div class="column">
                <div class="word">
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                </div>
                <div class="word">
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                </div>
            </div>
            <div class="column">
                <div class="word">
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                </div>
                <div class="word">
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                </div>
            </div>
            <div class="column">
                <div class="word">
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                    <span class="letter">_</span>
                </div>
            </div>
        </div>
    </div> -->
</body>
<script>
    const EMPTY = '_';
    const letters = Array.from(document.querySelectorAll(`[id^='letter-']`));
    const entries = Array.from(document.querySelectorAll(`[id^='entry-']`));

    Array.from('rescue').forEach((l, i) => {
        letters[i].placeholder = letters[i].value = l;
    });

    document.addEventListener('keydown', (event) => handleKeyDown(event.key));

    function handleKeyDown(key) {
        if (wasBackspacePressed(key)) {
            tryBackspace();
        } else if (wasLetterPressed(key)) {
            trySubmitLetter(key.toLowerCase());
        } else if (wasEnterPressed(key)) {
            trySubmitWord();
        }
    }

    function wasBackspacePressed(key) {
        return key === 'Backspace';
    }

    function wasEnterPressed(key) {
        return key === 'Enter';
    }

    function wasLetterPressed(key) {
        return key.match(/^[a-zA-Z]$/);
    }

    function tryBackspace() {
        const lastEntry = entries
            .filter(element => element.value)
            .last();

        if (!isNullOrUndefined(lastEntry)) {
            const letter = letters
                .filter(e => e.placeholder == lastEntry.value && e.value === EMPTY)
                .last();

            letter.value = letter.placeholder;
            lastEntry.removeAttribute(LetterBox.valueKey);
        }
    }

    function trySubmitLetter(key) {
        if (!isLetterAvailable(key)) {
            return;
        }

        const nextEntry = entries
            .filter(e => !e.value)
            .first();

        if (!isNullOrUndefined(nextEntry)) {
            const letter = letters
                .filter(element => element.value === key)
                .first();

            letter.value = EMPTY;
            nextEntry.value = key;
        }
    }

    function trySubmitWord() {
        console.log(entries.map(e => e.value).join(''));
    }

    function isLetterAvailable(key) {
        const letter = letters
            .filter(e => e.value === key)
            .first();

        return !!letter;
    }
</script>

</html>